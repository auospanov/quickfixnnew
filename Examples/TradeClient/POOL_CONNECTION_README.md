# Рефакторинг подключений к базе данных - Единый пул подключений

## Проблема
В проекте создавалось множество экземпляров `MyDbContext` напрямую через `new MyDbContext()`, что приводило к созданию множества подключений к базе данных и неэффективному использованию ресурсов. В профайлере SQL Server наблюдались множественные события "audit login" и "audit logout", что указывало на постоянное открытие и закрытие подключений.

## Решение
Реализован единый пул подключений через `AddDbContextPool` из Entity Framework Core. Это обеспечивает:
- Переиспользование экземпляров DbContext
- Переиспользование подключений к БД (подключения НЕ закрываются при Dispose(), а возвращаются в пул)
- Минимальное количество событий login/logout в SQL Server

## Изменения

### 1. Создан `DbContextFactory.cs`
- Singleton-фабрика для создания экземпляров `MyDbContext`
- Использует `AddDbContextPool` для реального пула подключений
- При `Dispose()` контекст возвращается в пул, а подключение к БД НЕ закрывается
- Размер пула: 128 экземпляров (стандартное значение)
- Включен retry механизм для обработки временных сбоев

### 2. Обновлен `MyDbContext.cs`
- Добавлен конструктор с `DbContextOptions<MyDbContext>` (рекомендуемый подход)
- Сохранен конструктор без параметров для обратной совместимости
- `OnConfiguring` используется только если DbContext создается без параметров

### 3. Обновлен `Program.cs`
- Инициализация `DbContextFactory` при старте приложения
- Автоматическое добавление параметров пула подключений к строке подключения
- Освобождение ресурсов фабрики при завершении приложения

### 4. Обновлены `TradeClientApp.cs` и `TradeClientApp1.cs`
- Все использования `new MyDbContext()` заменены на `DbContextFactory.Instance.CreateDbContext()`
- Все экземпляры DbContext теперь создаются через фабрику и используют единый пул

## Преимущества

1. **Контроль подключений**: Все подключения управляются через единую фабрику
2. **Эффективность**: Переиспользование подключений из пула снижает нагрузку на БД
3. **Масштабируемость**: Настроенные параметры пула позволяют контролировать максимальное количество подключений
4. **Надежность**: Встроенный retry механизм для обработки временных сбоев

## Использование

```csharp
// Вместо:
using (var db = new MyDbContext())
{
    // работа с БД
}

// Используйте:
using (var db = DbContextFactory.Instance.CreateDbContext())
{
    // работа с БД
}
```

## Настройка пула подключений

Параметры пула настраиваются в `DbContextFactory.cs`:
- `poolSize: 128` - размер пула экземпляров DbContext (можно изменить)
- `Max Pool Size=100` в строке подключения - максимальное количество физических подключений к SQL Server
- `Min Pool Size=5` в строке подключения - минимальное количество физических подключений к SQL Server

**Важно**: При использовании `AddDbContextPool`, подключения к БД переиспользуются и не закрываются при каждом `Dispose()`. Это означает, что в профайлере SQL Server вы должны видеть только одно событие "audit login" при старте приложения и одно "audit logout" при завершении, а не множество событий при каждой операции.

## Важно

- Фабрика должна быть инициализирована перед первым использованием (выполняется в `Program.cs`)
- Все экземпляры DbContext должны создаваться через фабрику
- Используйте `using` для правильного освобождения ресурсов
